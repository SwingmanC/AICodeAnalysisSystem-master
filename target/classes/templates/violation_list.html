<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:v-bind="http://www.w3.org/1999/xhtml">

<head>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="renderer" content="webkit">

    <title>源代码误报智能分析</title>

    <link href="/css/bootstrap.min.css?v=3.4.0" rel="stylesheet"/>
    <link href="/font-awesome/css/font-awesome.css?v=4.3.0" rel="stylesheet"/>
    <link href="/css/plugins/iCheck/custom.css" rel="stylesheet"/>
    <link href="/css/animate.css" rel="stylesheet"/>
    <link href="/css/style.css?v=2.2.0" rel="stylesheet"/>
    <link href="/css/plugins/jqgrid/ui.jqgrid.css?0820" rel="stylesheet">

    <!-- Mainly scripts -->
    <script src="/js/jquery.js"></script>
    <script src="/js/bootstrap.min.js?v=3.4.0"></script>
    <script src="/js/plugins/metisMenu/jquery.metisMenu.js"></script>
    <script src="/js/plugins/slimscroll/jquery.slimscroll.min.js"></script>
    <script src="/js/plugins/bootstrap-table/bootstrap-table.min.js"></script>
    <script src="/js/plugins/bootstrap-table/locale/bootstrap-table-zh-CN.min.js"></script>
    <script src="/js/plugins/jqgrid/i18n/grid.locale-cn.js?0820"></script>
    <script src="/js/plugins/jqgrid/jquery.jqGrid.min.js?0820"></script>

    <!-- Peity -->
    <script src="/js/plugins/peity/jquery.peity.min.js"></script>

    <!-- Custom and plugin javascript -->
    <script src="/js/hplus.js?v=2.2.0"></script>
    <script src="/js/plugins/pace/pace.min.js"></script>

    <!-- iCheck -->
    <script src="/js/plugins/iCheck/icheck.min.js"></script>

    <!-- Peity -->
    <script src="/js/demo/peity-demo.js"></script>
    <script src="/js/layer/layer.js"></script>
</head>

<body>
<div id="wrapper">
    <nav class="navbar-default navbar-static-side" role="navigation">
        <div class="sidebar-collapse">
            <ul class="nav" id="side-menu">
                <li class="nav-header">
                    <div class="dropdown profile-element"> <span>
                            <img alt="image" class="img-circle" src="/img/profile_small.jpg" />
                             </span>
                        <a data-toggle="dropdown" class="dropdown-toggle" href="#">
                                <span class="clear"> <span class="block m-t-xs"> <strong class="font-bold" th:text="${session.user.username}"></strong>
                             </span>  <span class="text-muted text-xs block">南京大学 <b class="caret"></b></span> </span>
                        </a>
                        <ul class="dropdown-menu animated fadeInRight m-t-xs">
                            <li><a href="#">修改头像</a>
                            </li>
                            <li><a href="/view/modify">个人资料</a>
                            </li>
                            <li><a href="#">联系我们</a>
                            </li>
                            <li><a href="#">信箱</a>
                            </li>
                            <li class="divider"></li>
                            <li><a href="/logout">安全退出</a>
                            </li>
                        </ul>
                    </div>
                    <div class="logo-element">
                        H+
                    </div>
                </li>
                <li class="active">
                    <a href="/view/projects"><i class="fa fa-tasks"></i> <span class="nav-label">我的任务</span></a>
                </li>
                <li>
                    <a href="/view/reports"><i class="fa fa-search"></i> <span class="nav-label">报告分析</span></a>
                </li>
                <li>
                    <a href="/view/templates"><i class="fa fa-file-text"></i> <span class="nav-label">模版管理</span></a>
                </li>
                <li>
                    <a href="/view/rules"><i class="fa fa-tags"></i> <span class="nav-label">规则管理</span></a>
                </li>
                <li>
                    <a href="#"><i class="fa fa-book"></i> <span class="nav-label">漏洞库管理</span></a>
                </li>
            </ul>

        </div>
    </nav>
    <div class="row border-bottom">
        <nav class="navbar navbar-static-top" role="navigation" style="margin-bottom: 0">
            <div class="navbar-header">
                <a class="navbar-minimalize minimalize-styl-2 btn btn-primary " href="#"><i class="fa fa-bars"></i> </a>
            </div>
            <ul class="nav navbar-top-links navbar-right">
                <li>
                    <a th:href="@{'/view/versions/'+${session.project.id}}">
                        <i class="fa fa-sign-out"></i> 返回
                    </a>
                </li>
            </ul>

        </nav>
    </div>
    <div id="page-wrapper" class="gray-bg dashbard-1">
        <div class="row wrapper border-bottom white-bg page-heading">
            <div class="col-lg-8">
                <h2>
                    <span th:text="${session.project.projectName}"></span>-
                    <span th:text="${session.version.version}"></span>
                </h2>
            </div>
            <div class="col-lg-4">
                <h2 style="text-align: right">
                    <span><a class="btn btn-primary" href="#" role="button" onclick="generate()">导出报告</a></span>
                    <span><a class="btn btn-warning" href="/view/violations/charts" role="button">可视化</a></span>
                </h2>
            </div>
        </div>
        <div class="wrapper wrapper-content animated fadeInRight">
            <div class="row">
                <div class="col-lg-12">
                    <div class="ibox float-e-margins">
                        <div class="ibox-title">
                            <h5>扫描结果</h5>
                            <div class="ibox-tools">
                                <a class="collapse-link">
                                    <i class="fa fa-chevron-up"></i>
                                </a>
                            </div>
                        </div>
                        <div class="ibox-content">
                            <a class="btn btn-primary" href="#" role="button" onclick="f_filter()">过滤相似警报</a>
                            <table class="table table-hover" id="f_violationTable"></table>
<!--                            <div class="jqGrid-wrapper">-->
<!--                                <table id="f_violationTable"></table>-->
<!--                                <div id="pager_list_1"></div>-->
<!--                            </div>-->
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal fade" tabindex="-1" role="dialog" id="infoModal">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 class="modal-title">详细信息</h3>
                    </div>
                    <div class="modal-body">
                        <div class="container">
                            <table>
                                <tr>
                                    <td>警报类型：</td>
                                    <td style="width: 350px;"><input type="text" class="form-control" id="type" readonly/></td>
                                </tr>
                                <tr>
                                    <td>警报种类：</td>
                                    <td style="width: 350px;"><input type="text" class="form-control" id="category" readonly/></td>
                                </tr>
                                <tr>
                                    <td>优先级：</td>
                                    <td style="width: 350px;"><input type="text" class="form-control" id="priority" readonly/></td>
                                </tr>
                                <tr>
                                    <td>警报所在类：</td>
                                    <td style="width: 350px;"><input type="text" class="form-control" id="classname" readonly/></td>
                                </tr>
                                <tr>
                                    <td>警报所在文件：</td>
                                    <td style="width: 350px;"><input type="text" class="form-control" id="sourcePath" readonly/></td>
                                </tr>
                                <tr>
                                    <td>警报所在方法：</td>
                                    <td style="width: 350px;"><input type="text" class="form-control" id="methodName" readonly/></td>
                                </tr>
                                <tr>
                                    <td>方法签名：</td>
                                    <td style="width: 350px;"><input type="text" class="form-control" id="signature" readonly/></td>
                                </tr>
                                <tr>
                                    <td>起始行：</td>
                                    <td style="width: 350px;"><input type="text" class="form-control" id="startLine" readonly/></td>
                                </tr>
                                <tr>
                                    <td>结束行：</td>
                                    <td style="width: 350px;"><input type="text" class="form-control" id="endLine" readonly/></td>
                                </tr>
                                <tr>
                                    <td>比对结果：</td>
                                    <td style="width: 350px;"><input type="text" class="form-control" id="state" readonly/></td>
                                </tr>
                            </table>
                            <style>
                                td{
                                    padding-bottom: 10px;
                                }
                            </style>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-danger" data-dismiss="modal">关闭</button>
                    </div>
                </div><!-- /.modal-content -->
            </div><!-- /.modal-dialog -->
        </div>
    </div>
</div>

<script th:inline="javascript">
    $(document).ready(function () {
        $("#f_violationTable").bootstrapTable({
            url:"/f_violations/0",  //请求地址
            striped : true, //是否显示行间隔色
            pageNumber : 1, //初始化加载第一页
            pagination : true,//是否分页
            sidePagination : 'client',//server:服务器端分页|client：前端分页
            pageSize : 10,//单页记录数
            pageList : [1, 5, 10],//可选择单页记录数
            showRefresh : true,//刷新按钮
            columns : [ {
                title : '#',
                field : 'id',
                sortable : true
            },{
                title : '警报类型',
                field : 'type',
                sortable : true
            },{
                title : '类名',
                field : 'classname',
                sortable : true
            },{
                title : '优先级',
                field : 'priority',
                sortable : true
            },{
                title : '方法名',
                field : 'methodName',
                sortable : true
            },{
                title : '置信值',
                field : 'likelihood',
                sortable : true
            },{
                title : '方差',
                field : 'variance',
                sortable : true
            },{
                field: 'operate',
                title: '操作',
                formatter: f_operateFormatter //自定义方法，添加操作按钮
            }]
        })
    });
    function f_filter() {
        $("#f_violationTable").bootstrapTable('refresh',{
            url:"/f_violations/1",  //请求地址
            striped : true, //是否显示行间隔色
            pageNumber : 1, //初始化加载第一页
            pagination : true,//是否分页
            sidePagination : 'client',//server:服务器端分页|client：前端分页
            pageSize : 10,//单页记录数
            pageList : [1, 5, 10],//可选择单页记录数
            showRefresh : true,//刷新按钮
            columns : [ {
                title : '#',
                field : 'id',
                sortable : true
            },{
                title : '警报类型',
                field : 'type',
                sortable : true
            },{
                title : '类名',
                field : 'classname',
                sortable : true
            },{
                title : '优先级',
                field : 'priority',
                sortable : true
            },{
                title : '方法名',
                field : 'methodName',
                sortable : true
            },{
                title : '置信值',
                field : 'likelihood',
                sortable : true
            },{
                title : '方差',
                field : 'variance',
                sortable : true
            },{
                field: 'operate',
                title: '操作',
                formatter: f_operateFormatter //自定义方法，添加操作按钮
            }]
        })
    }
    function f_operateFormatter(value, row, index){
        return "<a href='#' data-toggle='modal' data-target='#infoModal' onclick='f_watch(\""+row.id+"\")'><i class='fa fa-eye'></i> </a>";
    }
    function f_watch(id) {
        $.ajax({
            url:'/f_violation/'+id,
            type:'get',
            success:function(res){
                $("#type").val(res.type);
                $("#category").val(res.category);
                $("#priority").val(res.priority);
                $("#classname").val(res.classname);
                $("#sourcePath").val(res.sourcePath);
                $("#methodName").val(res.methodName);
                $("#signature").val(res.signature);
                $("#startLine").val(res.startLine);
                $("#endLine").val(res.endLine);
                $("#state").val(res.state);
            }
        })
    }
    function generate() {
        $.ajax({
            url:'/generate',
            responseType:'blob',
            method:'get',
            success:function (msg) {
                if (msg === 'null') layer.msg("请设置报告模版")
                else {
                    const blob = new Blob([msg], {type: 'application/vnd.ms-excel;charset=utf-8'});
                    const link = document.createElement('a'); // 创建a链接，用于下载文件
                    link.download = [[${session.project.projectName}]]+[[${session.version.version}]]+'.doc';
                    link.style.display = 'none';
                    link.href = URL.createObjectURL(blob);
                    document.body.appendChild(link);
                    link.click(); // 触发事件，下载文件
                    URL.revokeObjectURL(link.href) ;// 释放掉blob对象
                    document.body.removeChild(link) // 下载完成移除元素
                }
            }
        })
    }
</script>
</body>

</html>
